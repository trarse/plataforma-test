<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Test para Oposición de Conductor (Mejorada)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>

    <header>
      <div class="header-left">
          <h1>Plataforma de Test</h1>
          <p>Oposición Conductor/a UA</p>
      </div>
      <div class="header-controls">
          <div class="font-controls">
              <button id="decrease-font" title="Disminuir tamaño del texto">-A</button>
              <button id="increase-font" title="Aumentar tamaño del texto">+A</button>
          </div>
          <div class="dark-mode-switch">
              <input type="checkbox" id="theme-toggle">
              <label for="theme-toggle">🌙 Modo Oscuro</label>
          </div>
      </div>
      <div class="header-buttons">
          <button class="menu-toggle" id="menu-toggle" title="Mostrar/ocultar el temario">☰ Temario</button>
          <button class="home-button" id="home-button" title="Volver a la página de inicio">🏠 Inicio</button>
          <button class="stats-button" id="stats-button" title="Ver tus estadísticas y progreso">📊 Estadísticas</button>
          <button class="control-button" id="logout-button" title="Cerrar sesión" style="background-color: #d32f2f; color: white;">Salir</button>
      </div>
    </header>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <h2>Índice de Temas</h2>
            <ul id="menu-list"></ul>
        </nav>

        <main class="content" id="main-content">
            <section id="inicio" class="content-section active">
                <h2>Plataforma de Test Mejorada</h2>
                <p>Bienvenido/a. Usa las herramientas de esta página para optimizar tu estudio.</p>
                
                <div id="daily-challenge" class="study-tip">
                    <h3>🎯 Reto Diario</h3>
                    <p id="daily-challenge-p">¡Ponte a prueba con 10 preguntas aleatorias! Una forma rápida de repasar cada día.</p>
                    <button id="start-daily-challenge" class="control-button" style="background-color: var(--repetidas-color); color: white;">Empezar Reto</button>
                </div>
                
                <div class="test-config" id="search-container">
                    <h3>🔍 Buscar Preguntas por Palabra Clave</h3>
                    <div class="config-controls">
                        <input type="search" id="search-input" class="config-input" placeholder="Ej: alcoholemia, ABS, velocidad...">
                        <button id="search-button" class="control-button" style="background-color: var(--primary-color); color: white; width: auto;">Buscar</button>
                    </div>
                </div>

                <div class="test-config">
                    <h3>🎲 Crear Test Personalizado</h3>
                    <div class="config-controls">
                        <div style="width: 100%;">
                            <div class="checkbox-controls">
                                <button id="select-all-btn" class="control-button" style="background-color: #666; color: white; font-size: 0.8em; padding: 5px 10px;">Seleccionar Todo</button>
                                <button id="clear-all-btn" class="control-button" style="background-color: #666; color: white; font-size: 0.8em; padding: 5px 10px;">Limpiar Selección</button>
                            </div>
                            <div id="random-test-source-container"></div>
                        </div>
                        <input type="number" id="num-preguntas" class="config-input" placeholder="Nº de preguntas" min="1" value="50" style="width: 100%; margin-top: 10px;">
                        <button id="generar-test-button" class="control-button" style="background-color: var(--secondary-color); color: var(--text-color); width: 100%;">Generar Test Aleatorio</button>
                    </div>
                </div>
                
                <div class="study-tip" style="background-color: #e8f5e9; border-left: 5px solid var(--correct-color);">
                    <h3 style="color: var(--correct-color);">Opciones de Estudio y Repaso</h3>
                    <div class="repaso-options">
                        <button id="test-completo-button" class="control-button" style="background-color: var(--primary-color); color: white;">Test Completo</button>
                        <button id="repaso-repetidas-button" class="control-button" style="background-color: var(--repetidas-color); color: white;">Preguntas Más Repetidas</button>
                        <button id="repaso-marcadas-button" class="control-button" style="background-color: var(--marked-color); color: white;">Repasar Preguntas Marcadas</button>
                        <button id="repaso-fallos-button" class="control-button" style="background-color: var(--error-color); color: white;">Repasar Preguntas Falladas</button>
                        <button id="exam-mode-button" class="control-button" style="background-color: #0d47a1; color: white;">📝 Simulacro de Examen</button>
                    </div>
                </div>

                <div class="study-tip" style="background-color: #ffebee; border-left: 5px solid var(--error-color);">
                    <h3 style="color: var(--error-color);">🔄 Gestión de Datos y Estadísticas</h3>
                    <p>Puedes resetear tus estadísticas o descargar/cargar tu progreso para usarlo en otros dispositivos.</p>
                    <button id="reset-stats-button" class="reset-stats-button">Resetear Estadísticas Actuales</button>
                    <div class="repaso-options" style="margin-top: 10px;">
                         <button id="export-progress-button" class="control-button" style="background-color: #424242; color: white;">📥 Exportar Progreso</button>
                         <label for="import-progress-input" class="control-button" style="background-color: #424242; color: white; cursor: pointer;">📤 Importar Progreso</label>
                         <input type="file" id="import-progress-input" accept=".json" style="display: none;">
                    </div>
                </div>

                <div id="admin-panel" class="study-tip" style="display: none; border-left-color: var(--secondary-color);">
                    <h3>⚙️ Panel de Administración</h3>
                    <p>Sube un archivo .json para añadir nuevas preguntas al banco de datos.</p>
                    <div class="config-controls">
                        <input type="file" id="json-upload-input" accept=".json">
                        <button id="json-upload-button" class="control-button" style="background-color: var(--secondary-color);">Subir Preguntas</button>
                    </div>
                    <p id="upload-status" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
            </section>
            
            <section id="test-completo" class="content-section">
                <h2 id="test-title">Test</h2>
                <div class="performance-tracker">
                    <div id="timer-display"></div>
                    <div class="questions-counter" id="questions-counter"></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <div id="test-area"></div>
                <div id="test-controls" class="test-controls">
                    <button id="check-page-button" class="control-button">CORREGIR PÁGINA</button>
                    <button id="finish-normal-test-button" class="control-button" style="background-color: var(--secondary-color); color: var(--primary-color);">FINALIZAR TEST</button>
                    <button id="reset-page-button" class="control-button">REINICIAR PÁGINA</button>
                </div>
                <div id="test-results-page" style="margin-top: 15px; font-weight: bold; color: var(--primary-color); border: 1px solid; padding: 10px; border-radius: 5px; background: var(--section-bg);"></div>
                <div id="pagination" class="pagination-container"></div>
            </section>
            
            <section id="estadisticas-tema" class="content-section">
                <h2>📊 Estadísticas y Progreso</h2>
                <p>Consulta tu rendimiento. La <strong>Nota Neta</strong> se calcula como: `[(Aciertos - (Fallos / 3)) / Total] x 10`.</p>
                
                <div class="study-tip" style="background-color: #e3f2fd; border-left: 5px solid #1e88e5;">
                    <h3 style="color: #1e88e5;">Progreso General (Actual)</h3>
                    <div class="stats-container" id="global-stats-container"></div>
                </div>

                <div id="saved-progress-section">
                    <h3>💾 Comparativa de Progreso</h3>
                    <div id="saved-stats-display"></div>
                    <div class="saved-progress-controls">
                        <button id="save-progress-button" class="control-button" style="background-color: var(--correct-color); color: white;">Guardar Progreso Actual</button>
                        <button id="delete-saved-progress-button" class="control-button" style="background-color: var(--error-color); color: white;">Borrar Progreso Guardado</button>
                    </div>
                </div>

                <div id="charts-container" style="margin-top: 30px;">
                    <h3>📈 Visualización del Progreso</h3>
                    <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div class="chart-card" style="background-color: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4>Evolución en Simulacros (Nota Neta)</h4>
                            <canvas id="examScoreChart"></canvas>
                        </div>
                        <div class="chart-card" style="background-color: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4>Rendimiento por Bloque</h4>
                            <canvas id="themeBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="exam-history-container">
                    <h3>📜 Historial de Simulacros</h3>
                    <table id="exam-history-table">
                        <thead><tr><th>Fecha</th><th>Nota</th><th>Aciertos</th><th>Fallos</th><th>Tiempo</th><th>Acciones</th></tr></thead>
                        <tbody id="exam-history-body"></tbody>
                    </table>
                </div>

                <div id="achievements-container">
                    <h3>🏆 Logros Desbloqueados</h3>
                    <div id="achievements-list"></div>
                </div>
                
                <hr style="margin: 30px 0;">
                <h2>Estadísticas Detalladas por Bloque</h2>
                <div class="theme-stats-container" id="theme-stats-container"></div>
                <button id="reset-stats-button-2" class="reset-stats-button">Resetear Estadísticas Actuales</button>
            </section>
            
            <section id="exam-review" class="content-section">
                <h2 id="review-title">Revisión del Simulacro</h2>
                <button id="back-to-stats-button" class="control-button" style="background-color: #666; color: white; margin-bottom: 20px;">Volver a Estadísticas</button>
                <div id="review-area"></div>
            </section>
        </main>
    </div>

    <div id="achievement-popup" class="achievement-popup">
        <strong>🏆 ¡Logro Desbloqueado!</strong>
        <p id="achievement-popup-name"></p>
    </div>
    
    <div id="continue-test-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Test Incompleto Detectado</h2>
            <p>Hemos detectado un test que no terminaste. ¿Qué quieres hacer?</p>
            <div class="modal-actions" style="flex-wrap: wrap; justify-content: center;">
                <button id="resume-test-yes" class="control-button" style="background-color: var(--correct-color); color: white;">Continuar Test</button>
                <button id="finish-test-now" class="control-button" style="background-color: var(--secondary-color); color: var(--primary-color);">Finalizar y Corregir</button>
                <button id="resume-test-no" class="control-button cancel">Descartar y Empezar de Nuevo</button>
            </div>
        </div>
    </div>

    <div id="auth-modal-overlay" class="modal-overlay" style="display: flex;">
        <div class="modal-content" id="auth-modal-content">
            <h2 id="auth-title">Iniciar Sesión</h2>
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="Email" required autocomplete="email">
                <input type="password" id="auth-password" placeholder="Contraseña" required autocomplete="current-password">
                <p id="auth-error" style="color: var(--error-color); min-height: 1.2em;"></p>
                <button type="submit" id="auth-submit-button" class="control-button" style="width: 100%; background-color: var(--primary-color); color: white;">Entrar</button>
            </form>
            <p id="auth-toggle-text" style="margin-top: 15px; text-align: center;">¿No tienes cuenta? <a href="#" id="auth-toggle-link">Regístrate</a></p>
        </div>
    </div>

    <div id="edit-question-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Editar Pregunta</h2>
            <form id="edit-question-form">
                <input type="hidden" id="edit-question-id">
                <label for="edit-q">Texto de la pregunta:</label>
                <textarea id="edit-q" rows="4" required></textarea>
                <label for="edit-opts">Opciones (una por línea):</label>
                <textarea id="edit-opts" rows="4" required></textarea>
                <label for="edit-c">Respuesta Correcta (texto exacto):</label>
                <input type="text" id="edit-c" required>
                <label for="edit-expl">Explicación:</label>
                <textarea id="edit-expl" rows="3"></textarea>
                <label for="edit-s">Tema (ej: Tema 15):</label>
                <input type="text" id="edit-s" required>
                <div class="modal-actions">
                    <button type="submit" class="control-button">Guardar Cambios</button>
                    <button type="button" id="cancel-edit-btn" class="control-button cancel">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="./script.js"></script>
</body>
</html>